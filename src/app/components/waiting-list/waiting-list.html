<!-- โ ุดุฑูุท ุงูุฃุฒุฑุงุฑ -->
<div
  class="toolbar d-flex flex-wrap justify-content-end gap-3 position-relative mt-2"
>
  <div class="position-relative">
    <button class="btn btn-outline-primary" (click)="toggleRegisterForm()">
      โ ุชุณุฌูู ุตููุฉ ุฌุฏูุฏุฉ
    </button>
    <div class="arrow-wrapper" *ngIf="showRegisterForm">
      <i class="bi bi-caret-down-fill arrow-icon"></i>
    </div>
  </div>
</div>

<!-- โ ููุฑู ุชุณุฌูู ุงูุนููู -->
<div class="table-container mt-0" *ngIf="showRegisterForm" dir="rtl">
  <app-register-deal
    *ngIf="showRegisterForm"
    [deal]="selectedDeal"
    [isEditMode]="isEditMode"
    (closeForm)="toggleRegisterForm()"
    (refreshDeals)="getAllOperarions()"
  ></app-register-deal>
</div>

<div class="container-fluid mt-3" *ngIf="!showRegisterForm">
  <div class="table-responsive rounded-5">
    <p-table
      [value]="deals"
      [paginator]="false"
      [rows]="10"
      dir="rtl"
      stripedRows
      [tableStyle]="{ 'min-width': '50rem' }"
      [rowsPerPageOptions]="[10, 20]"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>
            <!-- <p-checkbox
              [(ngModel)]="selectAll"
              binary="true"
              (onChange)="toggleAll($event)"
            ></p-checkbox> -->
            ุงูุชูุงุตู
          </th>
          <th>ุฑูู ุงูุนูููุฉ</th>
          <th class="w-25">ุฅุณู ุงูุนููู</th>
          <th class="w-25">ุฑูู ุงูุชูุงุตู</th>
          <th>ุงูุฅูุชูุงู</th>
          <th>ุงูููุฒุงููุฉ</th>
          <th class="w-25">ุฅุณู ุงูููุธู</th>
          <th class="w-50">ุญุงูุฉ ุงูุนููู</th>
          <th>ุงูุฅุฌุฑุงุก</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-deal let-rowIndex="rowIndex">
        <tr [ngClass]="{ 'active-row': deal.active }">
          <td>
            <p-checkbox
              [(ngModel)]="deal.selected"
              binary="true"
              (onChange)="onSelectDeal(deal)"
            ></p-checkbox>
          </td>
          <td>{{ deal.id }}</td>
          <td class="pl-0">
            <div class="d-flex align-items-center">
              <a href="">{{ deal.name }}</a>
            </div>
          </td>

          <td>
            <a
              [href]="'https://wa.me/' + deal.phone"
              target="_blank"
              class="text-success text-decoration-none fw-bold"
            >
              {{ deal.phone }}
              <i class="bi bi-whatsapp ms-1"></i>
            </a>
          </td>
          <td>{{ getCountryNameById(deal.intersted) }}</td>
          <td>{{ deal.budget }}</td>

          <td>
            <a href="">{{ deal.empolyee }}</a>
          </td>
          <td>
            <div class="switch-wrapper">
              <span class="switch-label mx-1" [class.active]="!deal.active"
                >ุฌุงุฏ</span
              >
              <label class="custom-control ios-switch">
                <input
                  type="checkbox"
                  class="ios-switch-control-input"
                  [(ngModel)]="deal.active"
                  name="dealid"
                  (click)="onToggleActive(deal); $event.preventDefault()"
                />
                <span class="ios-switch-control-indicator"></span>
              </label>
              <span class="switch-label mx-1" [class.active]="deal.active"
                >ุบูุฑ ุฌุงุฏ</span
              >
            </div>
          </td>
          <td>
            <div class="py-1 d-flex flex-column gap-2 align-items-stretch">
              <button
                *ngIf="role === 1 || role === 2"
                class="btn btn-warning my-0 py-0"
                (click)="editModal(deal)"
              >
                ุชุนุฏูู
              </button>
              <button
                *ngIf="role === 1 || role === 2 || role === 3"
                class="btn btn-success my-0 py-0"
                (click)="openModal(deal)"
              >
                ุญูุธ
              </button>
              <button
                *ngIf="role === 1 || role === 2"
                class="btn btn-info my-0 py-0"
                (click)="openDetails(deal)"
              >
                ุชูุงุตูู
              </button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- โ ุงูููุฏุงู -->
<p-dialog
  [(visible)]="displayModal"
  [modal]="true"
  [closable]="false"
  [style]="{ width: '520px' }"
  [breakpoints]="{ '640px': '95vw' }"
  dir="rtl"
>
  <ng-template pTemplate="header">
    <div class="dialog-header">
      <div class="dialog-title">{{ titleModel }}</div>
    </div>
  </ng-template>

  <div class="dialog-body">
    <form class="form-grid">
      <!-- ุงูููุธู -->
      <!-- ุงูููุธู -->
      <div class="form-row">
        <label class="form-label">ุงูููุธู ุงููุณุคูู</label>

        <!-- ุญุงูุฉ ุงูุญูุธ (ุนุฑุถ ููุท) -->
        <input
          *ngIf="!editMode && !isDetailsMode"
          type="text"
          pInputText
          [value]="employeeName"
          readonly
          class="form-input"
        />

        <!-- ุญุงูุฉ ุงูุชุนุฏูู -->
        <select
          *ngIf="editMode && !isDetailsMode"
          class="form-select"
          [(ngModel)]="selectedSalesId"
          name="salesId"
        >
          <option value="" disabled selected>ุงุฎุชุฑ ููุธููุง ุฌุฏูุฏูุง</option>
          <option *ngFor="let s of salesList" [value]="s.Id">
            {{ s.FullName }}
          </option>
        </select>

        <!-- ุญุงูุฉ ุงูุชูุงุตูู -->
        <input
          *ngIf="isDetailsMode"
          type="text"
          pInputText
          [value]="employeeName"
          readonly
          class="form-input"
        />
      </div>

      <!-- ุงูููุช ูุงูุชุงุฑูุฎ -->
      <div class="form-row">
        <label class="form-label">ุงูููุช ูุงูุชุงุฑูุฎ</label>
        <input
          type="text"
          pInputText
          [value]="currentDateTime"
          readonly
          class="form-input"
        />
      </div>

      <!-- ุทุฑููุฉ ุงูุชูุงุตู -->
      <div class="form-row mb-2">
        <label class="form-label d-block">ุทุฑููุฉ ุงูุชูุงุตู</label>
        <select
          class="form-select"
          [(ngModel)]="selectedContactMethod"
          name="contactMethod"
          [disabled]="editMode || isDetailsMode"
        >
          <option value="" disabled selected>ุงุฎุชุฑ ุทุฑููุฉ ุงูุชูุงุตู</option>
          <option *ngFor="let method of contactMethods" [value]="method.value">
            {{ method.name }}
          </option>
        </select>
      </div>

      <div class="form-row" *ngIf="selectedContactMethod === 'call'">
        <label class="form-label d-block">ูุฏุฉ ุงูููุงููุฉ (ุฏูููุฉ)</label>
        <input
          type="number"
          class="form-control"
          [(ngModel)]="callDuration"
          name="callDuration"
          placeholder="ุงุฏุฎู ูุฏุฉ ุงูููุงููุฉ"
          min="1"
          [readonly]="editMode || isDetailsMode"
        />
      </div>

      <!-- ุงูููุงุญุธุงุช -->
      <div class="form-row textarea-row">
        <label class="form-label align-top">ุชูุงุตูู ุงูุชูุงุตู</label>
        <textarea
          pInputTextarea
          [(ngModel)]="message"
          [readonly]="editMode || isDetailsMode ? true : false"
          rows="3"
          class="form-textarea"
          name="message"
          placeholder="ุงูุชุจ ููุงุญุธุชู ููุง..."
        ></textarea>
      </div>

      <!-- ๐งพ ุงูุฃูุงูุฑ -->
      <div
        class="commands-box mt-3 p-2 border rounded bg-light"
        *ngIf="isDetailsMode"
      >
        <h6 class="fw-bold text-primary mb-2">ุณุฌู ุงูุฃูุงูุฑ</h6>
        <div *ngFor="let cmd of commands" class="mb-1 small">
          ๐ {{ cmd.AddedAt | date : "yyyy/MM/dd hh:mm a" }} โ
          <span class="text-dark">{{ cmd.Text }}</span>
        </div>
        <div *ngIf="!commands?.length" class="text-muted small">
          ูุง ุชูุฌุฏ ุฃูุงูุฑ ูุณุฌูุฉ
        </div>
      </div>
    </form>
  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <button
        pButton
        class="btn-cancel"
        (click)="displayModal = false"
        label="ุฅูุบุงุก"
      ></button>

      <!-- ุฒุฑ ุงูุญูุธ ูู ูุถุน ุชุนุฏูู -->
      <button
        pButton
        *ngIf="editMode"
        class="btn-save py-0"
        (click)="saveModal()"
        label="ุญูุธ ุงูุชุนุฏูู"
      ></button>

      <!-- ุฒุฑ ุงูุญูุธ ูู ูุถุน ุญูุธ ุฌุฏูุฏ -->
      <button
        pButton
        *ngIf="!editMode && !isDetailsMode"
        class="btn-save py-0"
        (click)="saveNewOperation()"
        label="ุญูุธ"
      ></button>
    </div>
  </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
