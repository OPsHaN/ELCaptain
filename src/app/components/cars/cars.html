<!-- âœ… Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
<div
  class="toolbar d-flex flex-wrap justify-content-between gap-3 position-relative mt-3 pb-0"
  dir="rtl"
>
  <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠÙ…Ù†: Ø²Ø±Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø¹Ø±Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© -->
  <div class="position-realtive">
    <button class="btn btn-outline-primary h-75" (click)="toggleRegisterForm()">
      ØªØ³Ø¬ÙŠÙ„ Ø¹Ø±Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© â•
    </button>
    <div class="arrow-wrapper" *ngIf="showRegisterForm">
      <i class="bi bi-caret-down-fill arrow-icon"></i>
    </div>
  </div>

  <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„Ø¨Ø­Ø« + Ø§Ù„Ù€ Dropdowns -->
  <div class="d-flex flex-wrap my-auto align-items-center gap-2" *ngIf="!showRegisterForm">
    <mat-form-field appearance="outline" class="custom-outline">
      <mat-label>Ø§Ù„Ø¯ÙˆÙ„Ø©</mat-label>
      <mat-select
        [(value)]="selectedCountry"
        (selectionChange)="onFilterChange()"
      >
        <mat-option value="">ÙƒÙ„ Ø§Ù„Ø¯ÙˆÙ„</mat-option>
        <mat-option *ngFor="let c of countries" [value]="c.id">
          <img
            [src]="c.img"
            alt="{{ c.name }}"
            width="20"
            height="20"
            class="me-2 rounded-circle"
          />
          {{ c.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- ğŸš˜ Dropdown 2 -->
    <mat-form-field appearance="outline" class="custom-outline">
      <mat-label>Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯</mat-label>
      <mat-select
        [(value)]="selectedBrand"
        (selectionChange)="onFilterChange()"
      >
        <mat-option value="">ÙƒÙ„ Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯Ø§Øª</mat-option>
        <mat-option *ngFor="let b of brands" [value]="b.Id">
          {{ b.BrandName }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- âš™ï¸ Dropdown 3 -->
    <mat-form-field appearance="outline" class="custom-outline">
      <mat-label>Ø§Ù„ÙØ±ÙˆØ¹</mat-label>
      <mat-select
        [(value)]="selectedBranch"
        (selectionChange)="onFilterChange()"
      >
        <mat-option value="">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</mat-option>
        <mat-option *ngFor="let b of branchs" [value]="b.Id">
          {{ b.BranchName }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <!-- ğŸ” Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« -->
  <mat-form-field appearance="outline" class="search-outline" *ngIf="!showRegisterForm">
    <mat-label>Ø¨Ø­Ø«</mat-label>
    <input
      matInput
      type="text"
      placeholder="Ø§Ø¨Ø­Ø«..."
      [(ngModel)]="searchText"
      (input)="applyFilters()"
    />
  </mat-form-field>
</div>

<!-- âœ… ÙÙˆØ±Ù… ØªØ³Ø¬ÙŠÙ„ / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
<div class="table-container mt-0" *ngIf="showRegisterForm" dir="rtl">
  <app-car-register
    *ngIf="showRegisterForm"
    [car]="selectedCar"
    (closeForm)="toggleRegisterForm()"
    [isEditMode]="isEditMode"
    (refreshCars)="loadCars()"
  ></app-car-register>
</div>

<!-- âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª -->
<div class="car-wrap pt-0" *ngIf="!showRegisterForm">
  <div class="cards-grid" dir="rtl">
    <div
      class="card car-card dome-card text-center position-relative"
      *ngFor="let car of filteredCars; trackBy: trackById"
      (click)="viewCar(car)"
      role="button"
      aria-label="Open car {{ car.Brand.BrandName }} {{ car.Model }}"
    >
      <!-- âœ… Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© -->
      <span
        class="status-badge"
        [ngClass]="{ online: car.IsForSale, offline: !car.IsForSale }"
      >
        {{ car.IsForSale ? "Ù…Ø¹Ø±ÙˆØ¶Ø© Ù„Ù„Ø¨ÙŠØ¹" : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆØ¶Ø©" }}
      </span>

      <!-- âœ… ØµÙˆØ±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
      <img
        [src]="car.Images.length ? car.Images[0].Img : defaultCarImage"
        class="card-img-top car-img"
        alt="{{ car.Brand.BrandName }}"
      />

      <div class="card-body p-0">
        <!-- Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ -->
        <h5 class="card-title fw-bold mb-2">
          {{ car.Model }}
        </h5>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª -->
        <table class="table table-borderless specs-table mb-3">
          <tbody>
            <tr>
              <td class="fw-bold">Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯</td>
              <td
                class="d-flex align-items-center gap-2 justify-content-center"
              >
                <img
                  [src]="car.Brand.Img || defaultCarImage"
                  alt="{{ car.Brand.CountryName }}"
                  class="country-flag rounded"
                />
                {{ car.Brand.BrandName }}
              </td>
            </tr>
            <tr>
              <td class="fw-bold">Ø§Ù„Ù„ÙˆÙ†</td>
              <td
                class="d-flex align-items-center justify-content-center gap-2"
              >
                <span
                  class="color-box"
                  [ngStyle]="{ backgroundColor: getColorCode(car.Color) }"
                ></span>
                {{ car.Color }}
              </td>
            </tr>
            <tr>
              <td class="fw-bold">Ø§Ù„Ø¯ÙˆÙ„Ø©</td>
              <td
                class="d-flex align-items-center gap-2 justify-content-center"
              >
                <img
                  [src]="car.Brand.Country.Img || defaultCarImage"
                  alt="{{ car.Brand.Country.CountryName }}"
                  class="country-flag rounded"
                />
                {{ car.Brand.Country.CountryName }}
              </td>
            </tr>
            <tr>
              <td class="fw-bold">Ø§Ù„ÙØ±Ø¹</td>
              <td
                class="d-flex align-items-center justify-content-center gap-2"
              >
                {{ getBranchName(car.BranchId) }}
              </td>
            </tr>
            <tr>
              <!-- âœ… Ù†ÙˆØ¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
              <td class="fw-bold">Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</td>
              <td class="text-center">
                <ng-container *ngIf="car.InstantDelivery; else storedCar">
                  <ng-container [ngSwitch]="car.InitiativeType">
                    <span *ngSwitchCase="1" class="text-primary fw-semibold"
                      >Ù…Ø¨Ø§Ø¯Ø±Ø©</span
                    >
                    <span *ngSwitchCase="2" class="text-info fw-semibold"
                      >Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø´Ø®ØµÙŠ</span
                    >
                    <span *ngSwitchDefault class="text-success fw-semibold"
                      >Ø§Ø³ØªÙŠØ±Ø§Ø¯</span
                    >
                  </ng-container>
                </ng-container>
                <ng-template #storedCar>
                  <span class="text-secondary fw-semibold">Ù…Ø®Ø²Ù†</span>
                </ng-template>
              </td>
            </tr>
            <!-- <tr>
              <td class="fw-bold">Ø§Ù„Ø­Ø§Ù„Ø©</td>
              <td [ngClass]="{ 'text-success': car.IsForSale, 'text-danger': !car.IsForSale }">
                {{ car.IsForSale ? 'Ù…Ø¹Ø±ÙˆØ¶Ø© Ù„Ù„Ø¨ÙŠØ¹' : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆØ¶Ø©' }}
              </td>
            </tr> -->
          </tbody>
        </table>
      </div>

      <!-- Ø§Ù„Ø³Ø¹Ø± -->
      <div class="car-price-box">{{ car.Price | number }} Ø¬Ù†ÙŠØ©</div>

      <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
      <div class="card-actions d-flex justify-content-center gap-2 p-2">
        <button
          class="btn btn-sm btn-success rounded-circle"
          (click)="editCar(car); $event.stopPropagation()"
        >
          âœï¸
        </button>
        <button
          class="btn btn-sm btn-danger rounded-circle"
          (click)="deleteCar(car); $event.stopPropagation()"
        >
          ğŸ—‘
        </button>
      </div>
    </div>
  </div>
</div>

<!-- âœ… Dialog Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ø¹ Carousel -->
<p-dialog
  header="ğŸš— Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©"
  [(visible)]="showCarDialog"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '550px' }"
  [baseZIndex]="10000"
  dir="rtl"
>
  <ng-container *ngIf="selectedCar">
    <div class="p-3 text-center">

      <!-- âœ… Carousel Ù„Ù„ØµÙˆØ± -->
      <p-carousel
        [value]="selectedCar.Images.length ? selectedCar.Images : [defaultCarImage]"
        [numVisible]="1"
        [numScroll]="1"
        [circular]="true"
        [autoplayInterval]="3000"
        [showIndicators]="true"
        [showNavigators]="true"
      >
        <ng-template pTemplate="item" let-image>
          <div class="car-image-wrapper">
            <img
              [src]="image.Img ? image.Img : image"
              class="car-image rounded-3 shadow-sm mb-3"
              alt="Car image"
            />
          </div>
        </ng-template>
      </p-carousel>

      <!-- ğŸ§¾ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
      <h4 class="fw-bold text-primary mb-2">
        {{ selectedCar.Brand.BrandName }} - {{ selectedCar.Model }}
      </h4>
      <p class="text-muted mb-3">
        {{ selectedCar.YearOfManufacture }} | {{ selectedCar.Color }}
      </p>

      <table class="table table-bordered align-middle text-center shadow-sm">
        <tbody>
          <tr>
            <th class="bg-light" style="width: 40%">ğŸ·ï¸ Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯</th>
            <td class="fw-semibold">
              <div class="d-flex align-items-center justify-content-center gap-2">
                <img
                  [src]="selectedCar.Brand.Img || defaultCarImage"
                  alt="{{ selectedCar.Brand.BrandName }}"
                  class="country-flag rounded"
                />
                {{ selectedCar.Brand.BrandName }}
              </div>
            </td>
          </tr>

          <tr>
            <th class="bg-light">ğŸ¨ Ø§Ù„Ù„ÙˆÙ†</th>
            <td>
              <div class="d-flex align-items-center justify-content-center gap-2">
                <span
                  class="color-box border rounded-circle"
                  [ngStyle]="{ backgroundColor: getColorCode(selectedCar.Color) }"
                  title="{{ selectedCar.Color }}"
                ></span>
                {{ selectedCar.Color }}
              </div>
            </td>
          </tr>

          <tr>
            <th class="bg-light">ğŸŒ Ø§Ù„Ø¯ÙˆÙ„Ø©</th>
            <td>
              <div class="d-flex align-items-center justify-content-center gap-2">
                <img
                  [src]="selectedCar.Brand.Country.Img || defaultCarImage"
                  alt="{{ selectedCar.Brand.Country.CountryName }}"
                  class="country-flag rounded"
                />
                {{ selectedCar.Brand.Country.CountryName }}
              </div>
            </td>
          </tr>

          <tr>
            <th class="bg-light">âš™ï¸ Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹</th>
            <td>{{ selectedCar.YearOfManufacture }}</td>
          </tr>

          <tr>
            <th class="bg-light">ğŸš˜ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª</th>
            <td>{{ selectedCar.Kilometers | number }} ÙƒÙ…</td>
          </tr>

          <tr>
            <th class="bg-light">ğŸ’° Ø§Ù„Ø³Ø¹Ø±</th>
            <td class="fw-bold text-success">
              {{ selectedCar.Price | number }} Ø¬Ù†ÙŠÙ‡
            </td>
          </tr>

          <tr>
            <th class="bg-light">ğŸ“¦ Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <td>
              <span
                [ngClass]="{
                  'text-success fw-bold': selectedCar.IsForSale,
                  'text-danger fw-bold': !selectedCar.IsForSale
                }"
              >
                {{ selectedCar.IsForSale ? 'Ù…Ø¹Ø±ÙˆØ¶Ø© Ù„Ù„Ø¨ÙŠØ¹ âœ…' : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆØ¶Ø© âŒ' }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>
</p-dialog>


<p-confirmDialog></p-confirmDialog>
