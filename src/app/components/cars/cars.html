<!-- โ ุดุฑูุท ุงูุฃุฏูุงุช -->
<div
  class="toolbar d-flex flex-wrap justify-content-between gap-3 position-relative mt-3 pb-0"
  dir="rtl"
>
  <!-- ุงููุณู ุงูุฃููู: ุฒุฑุงุฑ ุชุณุฌูู ุนุฑุจูุฉ ุฌุฏูุฏุฉ -->
  <div class="position-realtive">
    <button class="btn btn-outline-primary h-75" (click)="toggleRegisterForm()">
      ุชุณุฌูู ุนุฑุจูุฉ ุฌุฏูุฏุฉ โ
    </button>
    <div class="arrow-wrapper" *ngIf="showRegisterForm">
      <i class="bi bi-caret-down-fill arrow-icon"></i>
    </div>
  </div>

  <!-- ุงููุณู ุงูุฃูุณุฑ: ุงูุจุญุซ + ุงูู Dropdowns -->
  <div class="d-flex flex-wrap my-auto align-items-center gap-2">
    <mat-form-field appearance="outline" class="custom-outline">
      <mat-label>ุงูุฏููุฉ</mat-label>
      <mat-select
        [(value)]="selectedCountry"
        (selectionChange)="onFilterChange()"
      >
        <mat-option value="">ูู ุงูุฏูู</mat-option>
        <mat-option *ngFor="let c of countries" [value]="c.id">
          <img
            [src]="c.img"
            alt="{{ c.name }}"
            width="20"
            height="20"
            class="me-2 rounded-circle"
          />
          {{ c.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- ๐ Dropdown 2 -->
    <mat-form-field appearance="outline" class="custom-outline">
      <mat-label>ุงูุจุฑุงูุฏ</mat-label>
      <mat-select
        [(value)]="selectedBrand"
        (selectionChange)="onFilterChange()"
      >
        <mat-option value="">ูู ุงูุจุฑุงูุฏุงุช</mat-option>
        <mat-option *ngFor="let b of brands" [value]="b.Id">
          {{ b.BrandName }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- โ๏ธ Dropdown 3 -->
    <mat-form-field appearance="outline" class="custom-outline">
      <mat-label>ุงููุฑูุน</mat-label>
      <mat-select
        [(value)]="selectedBranch"
        (selectionChange)="onFilterChange()"
      >
        <mat-option value="">ูู ุงููุฑูุน</mat-option>
        <mat-option *ngFor="let b of branchs" [value]="b.Id">
          {{ b.BranchName }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <!-- ๐ ูุฑุจุน ุงูุจุญุซ -->
  <mat-form-field appearance="outline" class="search-outline">
    <mat-label>ุจุญุซ</mat-label>
    <input
      matInput
      type="text"
      placeholder="ุงุจุญุซ..."
      [(ngModel)]="searchText"
      (input)="filterBySearch()"
    />
  </mat-form-field>
</div>

<!-- โ ููุฑู ุชุณุฌูู / ุชุนุฏูู ุงูุณูุงุฑุฉ -->
<div class="table-container mt-0" *ngIf="showRegisterForm" dir="rtl">
  <app-car-register
    *ngIf="showRegisterForm"
    [car]="selectedCar"
    (closeForm)="toggleRegisterForm()"
    [isEditMode]="isEditMode"
    (refreshCars)="loadCars()"
  ></app-car-register>
</div>

<!-- โ ุฌุฏูู ุงูุณูุงุฑุงุช -->
<div class="car-wrap" *ngIf="!showRegisterForm">
  <div class="cards-grid" dir="rtl">
    <div
      class="card car-card dome-card text-center position-relative"
      *ngFor="let car of filteredCars; trackBy: trackById"
      (click)="viewCar(car)"
      role="button"
      aria-label="Open car {{ car.Brand.BrandName }} {{ car.Model }}"
    >
      <!-- โ ุญุงูุฉ ุงูุณูุงุฑุฉ ุฃุนูู ูููู ุงูุตูุฑุฉ -->
      <span
        class="status-badge"
        [ngClass]="{ online: car.IsForSale, offline: !car.IsForSale }"
      >
        {{ car.IsForSale ? "ูุนุฑูุถุฉ ููุจูุน" : "ุบูุฑ ูุนุฑูุถุฉ" }}
      </span>

      <!-- โ ุตูุฑุฉ ุงูุณูุงุฑุฉ -->
      <img
        [src]="car.Images.length ? car.Images[0].Img : defaultCarImage"
        class="card-img-top car-img"
        alt="{{ car.Brand.BrandName }}"
      />

      <div class="card-body p-0">
        <!-- ุงุณู ุงูููุฏูู -->
        <h5 class="card-title fw-bold mb-2">
          {{ car.Model }}
        </h5>

        <!-- ุฌุฏูู ุงูููุงุตูุงุช -->
        <table class="table table-borderless specs-table mb-3">
          <tbody>
            <tr>
              <td class="fw-bold">ุงูุจุฑุงูุฏ</td>
              <td
                class="d-flex align-items-center gap-2 justify-content-center"
              >
                <img
                  [src]="car.Brand.Img || defaultCarImage"
                  alt="{{ car.Brand.CountryName }}"
                  class="country-flag rounded"
                />
                {{ car.Brand.BrandName }}
              </td>
            </tr>
            <tr>
              <td class="fw-bold">ุงูููู</td>
              <td
                class="d-flex align-items-center justify-content-center gap-2"
              >
                <span
                  class="color-box"
                  [ngStyle]="{ backgroundColor: getColorCode(car.Color) }"
                ></span>
                {{ car.Color }}
              </td>
            </tr>
            <tr>
              <td class="fw-bold">ุงูุฏููุฉ</td>
              <td
                class="d-flex align-items-center gap-2 justify-content-center"
              >
                <img
                  [src]="car.Brand.Country.Img || defaultCarImage"
                  alt="{{ car.Brand.Country.CountryName }}"
                  class="country-flag rounded"
                />
                {{ car.Brand.Country.CountryName }}
              </td>
            </tr>
            <tr>
              <td class="fw-bold">ุงููุฑุน</td>
              <td
                class="d-flex align-items-center justify-content-center gap-2"
              >
                {{ getBranchName(car.BranchId) }}
              </td>
            </tr>
            <tr>
              <!-- โ ููุน ุชุณุฌูู ุงูุณูุงุฑุฉ -->
              <td class="fw-bold">ููุน ุงูุชุณุฌูู</td>
              <td class="text-center">
                <ng-container *ngIf="car.InstantDelivery; else storedCar">
                  <ng-container [ngSwitch]="car.InitiativeType">
                    <span *ngSwitchCase="1" class="text-primary fw-semibold"
                      >ูุจุงุฏุฑุฉ</span
                    >
                    <span *ngSwitchCase="2" class="text-info fw-semibold"
                      >ุงุณุชูุฑุงุฏ ุดุฎุตู</span
                    >
                    <span *ngSwitchDefault class="text-success fw-semibold"
                      >ุงุณุชูุฑุงุฏ</span
                    >
                  </ng-container>
                </ng-container>
                <ng-template #storedCar>
                  <span class="text-secondary fw-semibold">ูุฎุฒู</span>
                </ng-template>
              </td>
            </tr>
            <!-- <tr>
              <td class="fw-bold">ุงูุญุงูุฉ</td>
              <td [ngClass]="{ 'text-success': car.IsForSale, 'text-danger': !car.IsForSale }">
                {{ car.IsForSale ? 'ูุนุฑูุถุฉ ููุจูุน' : 'ุบูุฑ ูุนุฑูุถุฉ' }}
              </td>
            </tr> -->
          </tbody>
        </table>
      </div>

      <!-- ุงูุณุนุฑ -->
      <div class="car-price-box">{{ car.Price | number }} ุฌููุฉ</div>

      <!-- ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช -->
      <div class="card-actions d-flex justify-content-center gap-2 p-2">
        <button
          class="btn btn-sm btn-success rounded-circle"
          (click)="editCar(car); $event.stopPropagation()"
        >
          โ๏ธ
        </button>
        <button
          class="btn btn-sm btn-danger rounded-circle"
          (click)="deleteCar(car); $event.stopPropagation()"
        >
          ๐
        </button>
      </div>
    </div>
  </div>
</div>

<!-- โ Dialog ุนุฑุถ ุจูุงูุงุช ุงูุณูุงุฑุฉ ูุน Carousel -->
<p-dialog
  header="๐ ุจูุงูุงุช ุงูุณูุงุฑุฉ"
  [(visible)]="showCarDialog"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '500px' }"
  [baseZIndex]="10000"
  dir="rtl"
>
  <ng-container *ngIf="selectedCar">
    <div class="text-center p-2">
      <!-- โ Carousel ููุตูุฑ -->
      <p-carousel
        [value]="
          selectedCar.Images.length ? selectedCar.Images : [defaultCarImage]
        "
        [numVisible]="1"
        [numScroll]="1"
        [circular]="true"
        [autoplayInterval]="3000"
        [showIndicators]="false"
        [showNavigators]="true"
      >
        <ng-template pTemplate="item" let-image>
          <div class="car-image-wrapper">
            <img
              [src]="image.Img ? image.Img : image"
              class="car-image rounded mb-3"
              alt="Car image"
            />
          </div>
        </ng-template>
      </p-carousel>

      <!-- ๐งพ ุจูุงูุงุช ุงูุณูุงุฑุฉ -->
      <h4 class="fw-bold mb-3">
        {{ selectedCar.Brand.BrandName }} - {{ selectedCar.Model }}
      </h4>

      <table class="table table-borderless specs-table mb-3 text-center">
        <tbody>
          <tr>
            <td class="fw-bold">ุงูุจุฑุงูุฏ</td>
            <td class="d-flex align-items-center gap-2 justify-content-center">
              <img
                [src]="selectedCar.Brand.Img || defaultCarImage"
                alt="{{ selectedCar.Brand.BrandName }}"
                class="country-flag rounded"
              />
              {{ selectedCar.Brand.BrandName }}
            </td>
          </tr>
          <tr>
            <td class="fw-bold">ุงูููู</td>
            <td class="d-flex align-items-center justify-content-center gap-2">
              <span
                class="color-box"
                [ngStyle]="{ backgroundColor: getColorCode(selectedCar.Color) }"
              ></span>
              {{ selectedCar.Color }}
            </td>
          </tr>
          <tr>
            <td class="fw-bold">ุงูุฏููุฉ</td>
            <td class="d-flex align-items-center gap-2 justify-content-center">
              <img
                [src]="selectedCar.Brand.Country.Img || defaultCarImage"
                alt="{{ selectedCar.Brand.Country.CountryName }}"
                class="country-flag rounded"
              />
              {{ selectedCar.Brand.Country.CountryName }}
            </td>
          </tr>
          <tr>
            <td class="fw-bold">ุณูุฉ ุงูุตูุน</td>
            <td>{{ selectedCar.YearOfManufacture }}</td>
          </tr>
          <tr>
            <td class="fw-bold">ุงููููู ูุชุฑ</td>
            <td>{{ selectedCar.Kilometers }}</td>
          </tr>
          <tr>
            <td class="fw-bold">ุงูุณุนุฑ</td>
            <td>{{ selectedCar.Price | number }} ุฌููุฉ</td>
          </tr>
          <tr>
            <td class="fw-bold">ุงูุญุงูุฉ</td>
            <td
              [ngClass]="{
                'text-success': selectedCar.IsForSale,
                'text-danger': !selectedCar.IsForSale
              }"
            >
              {{ selectedCar.IsForSale ? "ูุนุฑูุถุฉ ููุจูุน" : "ุบูุฑ ูุนุฑูุถุฉ" }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
